!function(t){if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof exports){var e=t();"undefined"!=typeof module&&module.exports&&(module.exports=e),exports=e}else window.purl=t()}(function(){"use strict";var t=function(){return(new Date).getTime()},e=function(t,e){this.opts=e||{},this.opts.idleDelay=this.opts.idleDelay||1e3,this.opts.omitWhitespace=this.opts.omitWhitespace||!1,this.opts.maxInterval=this.opts.maxInterval||6e3,this.opts.maxundoStackSize=this.opts.maxundoStackSize||100,this.opts.redoKeys=this.opts.redoKeys||[17,89],this.opts.undoKeys=this.opts.undoKeys||[17,90],this.el=t,this.contextMenuActive=!1,this.exceededMaxundoStackSize=!1,this.idle=!0,this.lastAction=0,this.lastAltered=0,this.lastSnapshotAttempt=0,this.pressed=[],this.snapCounter=0,this.undoStack=[],this.redoStack=[],this.on(),this.snapshot(!0)};return e.prototype.actions=["redo","undo"],e.prototype.on=function(){this.el.addEventListener("keydown",this.down.bind(this)),this.el.addEventListener("keyup",this.up.bind(this)),this.el.addEventListener("mouseup",this.mouse.bind(this))},e.prototype.off=function(){this.el.removeEventListener("keydown",this.down),this.el.removeEventListener("keyup",this.up),this.el.removeEventListener("mouseup",this.mouse)},e.prototype.down=function(t){if(this.eventFired(t),this.redoStack.length&&(8===t.keyCode||13===t.keyCode||t.keyCode>47&&t.keyCode<91||t.keyCode>185)){var e;this.pressed.forEach(function(t){t>=17&&19>=t&&(e=!0)}),e||(this.redoStack=[])}-1===this.pressed.indexOf(t.keyCode)&&this.pressed.push(t.keyCode),this.compareKeys(t)},e.prototype.up=function(e){this.eventFired(e);var s=this.pressed.indexOf(e.keyCode);s>-1&&this.pressed.splice(s,1),this.compareKeys(e)||(this.lastAltered=t()),setTimeout(this.idleCheck.bind(this,t()),this.opts.idleDelay+5)},e.prototype.mouse=function(e){this.eventFired(e),3===e.which&&(this.contextMenuActive=!0),setTimeout(this.idleCheck.bind(this,t()),this.opts.idleDelay+5)},e.prototype.eventFired=function(){this.contextMenuActive&&(this.contextMenuActive=!1,this.lastAltered=t(),this.snapshot()),this.idle&&(this.idle=!1,setTimeout(this.intervalCheck.bind(this,this.undoStack.length?this.undoStack[this.undoStack.length-1].index:null),this.opts.maxInterval))},e.prototype.idleCheck=function(t){t>=this.lastAltered&&(this.snapshot(),this.idle=!0)},e.prototype.intervalCheck=function(t){"number"==typeof t&&t<=this.snapCounter&&this.snapshot()},e.prototype.compareKeys=function(t){var e=!1;return this.actions.forEach(function(s){if(!e&&this.opts[s+"Keys"].length===this.pressed.length){var i=0;this.opts[s+"Keys"].forEach(function(t){var e=this.pressed.indexOf(t);e>-1&&i++}.bind(this)),i===this.pressed.length&&(e=!0,this[s](t))}}.bind(this)),e},e.prototype.redo=function(e){if(e&&e.preventDefault(),this.redoStack.length){var s=this.redoStack.pop();if(!s)return;this.undoStack.push(s),this.diff(this.el.value,s.val,this.opts.omitWhitespace)||(s=this.redoStack.pop(),this.undoStack.push(s)),this.el.value=s.val,this.lastAction=t()}},e.prototype.undo=function(e){if(e&&e.preventDefault(e),this.undoStack.length){var s=this.undoStack.pop();if(!s||!s.val)return void(this.el.value="");this.redoStack.push(s),this.diff(this.el.value,s.val,this.opts.omitWhitespace)||(s=this.undoStack.pop(),this.redoStack.push(s)),this.el.value=s&&s.val?s.val:"",this.lastAction=t()}else this.el.value=""},e.prototype.snapshot=function(e){var s=this.el.value,i=this.undoStack.length?this.undoStack[this.undoStack.length-1].val:"";return this.lastSnapshotAttempt=t(),e||!this.redoStack.length&&this.diff(s,i,this.opts.omitWhitespace)?(this.undoStack.length>=this.opts.maxundoStackSize&&(this.exceededMaxundoStackSize=!0,this.undoStack.shift()),this.undoStack.push({index:this.snapCounter,val:s,recorded:t()}),this.snapCounter++,e&&(this.redoStack=[]),!0):!1},e.prototype.diff=function(t,e,s){return s=s||this.omitWhitespace||!1,s&&(t=(t||"").replace(/\s/gi,"")||"",e=(e||"").replace(/\s/gi,"")||""),t!==e},e.prototype.reset=function(t){this.undoStack=[],this.redoStack=[],t&&(this.el.value="")},e});