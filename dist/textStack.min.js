!function(t){if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof exports){var e=t();"undefined"!=typeof module&&module.exports&&(module.exports=e),exports=e}else window.TextStack=t()}(function(){"use strict";var t=function(){return(new Date).getTime()},e=function(t,e){this.opts=e||{},this.opts.idleDelay=this.opts.idleDelay||500,this.opts.omitWhitespace=this.opts.omitWhitespace||!1,this.opts.maxInterval=this.opts.maxInterval&&this.opts.maxInterval>1.2*this.opts.idleDelay?e.maxInterval:1.2*this.opts.idleDelay<4e3?4e3:1.2*this.opts.idleDelay,this.opts.maxUndoStackSize=this.opts.maxUndoStackSize||100,this.opts.redoKeys=this.opts.redoKeys||[17,89],this.opts.undoKeys=this.opts.undoKeys||[17,90],this.el=t,this.contextMenuActive=!1,this.exceededMaxUndoStackSize=!1,this.idle=!0,this.lastAction=0,this.lastAltered=0,this.lastSnapshotAttempt=0,this.pressed=[],this.snapCounter=0,this.undoStack=[],this.redoStack=[],this.on(),this.snapshot(!0)};return e.prototype.actions=["redo","undo"],e.prototype.on=function(){this.listeners={keydown:this.down.bind(this),keyup:this.up.bind(this),mouseup:this.mouse.bind(this),blur:this.clear.bind(this),focus:"blur"};for(var t in this.listeners)"function"==typeof this.listeners[t]?this.el.addEventListener(t,this.listeners[t]):"string"==typeof this.listeners[t]&&this.el.addEventListener(t,this.listeners[this.listeners[t]])},e.prototype.off=function(){for(var t in this.listeners)"function"==typeof this.listeners[t]?this.el.removeEventListener(t,this.listeners[t]):"string"==typeof this.listeners[t]&&this.el.removeEventListener(t,this.listeners[this.listeners[t]]);this.listeners=null},e.prototype.down=function(e){this.eventFired(e);var s,i;this.redoStack.length&&(8===e.keyCode||13===e.keyCode||e.keyCode>47&&e.keyCode<91||e.keyCode>185)&&(this.pressed.forEach(function(t){t>=16&&18>=t&&(s=i=!0)}),i||(this.redoStack=[])),-1===this.pressed.indexOf(e.keyCode)&&this.pressed.push(e.keyCode),2===this.pressed.length&&2===[17,86].filter(function(t){return-1!==this.pressed.indexOf(t)}.bind(this)).length&&(this.snapshot(),this.redoStack=[],s=!1),s||(this.lastAltered=t()),this.compareKeys(e)},e.prototype.up=function(e){this.eventFired(e);var s=this.pressed.indexOf(e.keyCode);s>-1&&this.pressed.splice(s,1),this.compareKeys(e)||(this.lastAltered=t()),setTimeout(this.idleCheck.bind(this,t()),this.opts.idleDelay+5)},e.prototype.mouse=function(e){this.eventFired(e),3===e.which&&(this.contextMenuActive=!0),setTimeout(this.idleCheck.bind(this,t()),this.opts.idleDelay+5)},e.prototype.clear=function(t){this.eventFired(t),this.pressed=[]},e.prototype.eventFired=function(){this.contextMenuActive&&(this.contextMenuActive=!1,this.lastAltered=t(),this.snapshot()),this.idle&&(this.idle=!1,setTimeout(this.intervalCheck.bind(this,this.undoStack.length?this.undoStack[this.undoStack.length-1].index:0),this.opts.maxInterval))},e.prototype.idleCheck=function(t){t>=this.lastAltered&&(this.snapshot(),this.idle=!0)},e.prototype.intervalCheck=function(t){"number"==typeof t&&t<=this.snapCounter&&this.snapshot()&&setTimeout(this.intervalCheck.bind(this,this.undoStack.length?this.undoStack[this.undoStack.length-1].index:0),this.opts.maxInterval)},e.prototype.compareKeys=function(t){var e=!1;return this.actions.forEach(function(s){if(!e&&this.opts[s+"Keys"].length===this.pressed.length){var i=0;this.opts[s+"Keys"].forEach(function(t){var e=this.pressed.indexOf(t);e>-1&&i++}.bind(this)),i===this.pressed.length&&(e=!0,this[s](t))}}.bind(this)),e},e.prototype.redo=function(e){e&&e.preventDefault();var s;this.redoStack.length&&(s=this.redoStack.pop(),this.undoStack.push(s),this.diff(this.el.value,s.val,this.opts.omitWhitespace)||(s=this.redoStack.pop(),this.undoStack.push(s)),this.el.value=s.val,this.lastAction=t())},e.prototype.undo=function(e){e&&e.preventDefault(e);var s;this.undoStack.length?(this.snapshot(),s=this.undoStack.pop(),this.redoStack.push(s),this.diff(this.el.value,s.val,this.opts.omitWhitespace)||(s=this.undoStack.pop(),this.redoStack.push(s)),this.el.value=s&&s.val?s.val:"",this.lastAction=t()):this.el.value=""},e.prototype.snapshot=function(e){var s=this.el.value,i=this.undoStack.length?this.undoStack[this.undoStack.length-1].val:"";return this.lastSnapshotAttempt=t(),e||!this.redoStack.length&&this.diff(s,i,this.opts.omitWhitespace)?(this.undoStack.length>=this.opts.maxUndoStackSize&&(this.exceededMaxUndoStackSize=!0,this.undoStack.shift()),this.undoStack.push({index:this.snapCounter,val:s,recorded:t()}),this.snapCounter++,e&&(this.redoStack=[]),!0):!1},e.prototype.diff=function(t,e,s){return s=s||this.omitWhitespace||!1,s&&(t=(t||"").replace(/\s/gi,"")||"",e=(e||"").replace(/\s/gi,"")||""),t!==e},e.prototype.reset=function(t){this.undoStack=[],this.redoStack=[],t&&(this.el.value="")},e});